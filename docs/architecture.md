# アーキテクチャ

## 全体構成図

```
                         ┌──────────────────────────────────────────────────────────┐
                         │                      AWS Cloud                           │
                         │                  (ap-northeast-1)                        │
                         │                                                          │
  ユーザー ──────────▶   │   ┌──────────┐    ┌─────────────────────────────────┐    │
                         │   │ Route 53 │───▶│         CloudFront              │    │
                         │   └──────────┘    │  ┌─────────┐   ┌───────────┐   │    │
                         │                   │  │ S3      │   │ ALB       │   │    │
                         │                   │  │(React   │   │(Backend   │   │    │
                         │                   │  │ SPA)    │   │ Origin)   │   │    │
                         │                   │  └─────────┘   └─────┬─────┘   │    │
                         │                   └──────────────────────┼──────────┘    │
                         │                                          │               │
                         │              VPC (10.x.0.0/16)           │               │
                         │   ┌──────────────────────────────────────┼───────────┐   │
                         │   │  Public Subnet (x2 AZ)              │           │   │
                         │   │   ┌─────────┐  ┌──────────────┐     │           │   │
                         │   │   │   ALB   │◀─┘  NAT Gateway │     │           │   │
                         │   │   └────┬────┘     └─────┬──────┘     │           │   │
                         │   ├────────┼────────────────┼────────────┼───────────┤   │
                         │   │  Private Subnet (x2 AZ) │                       │   │
                         │   │   ┌────▼──────────────┐ │                       │   │
                         │   │   │   ECS Fargate     │─┘                       │   │
                         │   │   │   (FastAPI)       │                         │   │
                         │   │   └────┬──────────────┘                         │   │
                         │   ├────────┼────────────────────────────────────────┤   │
                         │   │  Private Subnet (x2 AZ)                        │   │
                         │   │   ┌────▼──────────────┐                         │   │
                         │   │   │  RDS PostgreSQL   │                         │   │
                         │   │   │  (16)             │                         │   │
                         │   │   └───────────────────┘                         │   │
                         │   └─────────────────────────────────────────────────┘   │
                         │                                                          │
                         │   ┌──────────────┐  ┌────────────┐  ┌──────────────┐    │
                         │   │   Secrets    │  │ CloudWatch │  │    WAF       │    │
                         │   │   Manager   │  │ (監視)     │  │ (prod のみ) │    │
                         │   └──────────────┘  └────────────┘  └──────────────┘    │
                         └──────────────────────────────────────────────────────────┘

外部サービス:
  → OpenAI / Anthropic / Google Gemini (LLM API)
  → GitHub API
  → Qdrant (ベクトルDB)
  → W&B (実験追跡)
  → Langfuse (LLM 可観測性)
  → Semantic Scholar / arXiv / OpenAlex
```

## リクエストフロー

```
ユーザー
  │
  ▼
Route 53 (DNS)
  │
  ▼
CloudFront (CDN + WAF)
  │
  ├── 静的コンテンツ ──▶ S3 (React SPA)
  │
  └── /api/* ──▶ ALB (HTTPS)
                  │
                  ▼
              ECS Fargate (FastAPI)
                  │
                  ▼
              RDS PostgreSQL (Private Subnet)
```

## CI/CD パイプライン

```
┌─────────────────────────────────────────────────────────┐
│                    GitHub Actions                        │
│                                                          │
│  OIDC ──▶ IAM Role (長期キー不使用)                     │
│                                                          │
│  ┌─────────────────────────┐  ┌────────────────────────┐│
│  │ Frontend Deploy         │  │ Backend Deploy         ││
│  │                         │  │                        ││
│  │ npm build               │  │ Docker build           ││
│  │   ▼                     │  │   ▼                    ││
│  │ S3 sync                 │  │ ECR push               ││
│  │   ▼                     │  │   ▼                    ││
│  │ CloudFront invalidation │  │ ECS service update     ││
│  └─────────────────────────┘  └────────────────────────┘│
│                                                          │
│  ┌─────────────────────────┐                             │
│  │ Terraform               │                             │
│  │ plan → apply            │                             │
│  └─────────────────────────┘                             │
└─────────────────────────────────────────────────────────┘

デプロイフロー:
  develop push  → dev 環境に自動デプロイ
  staging push  → staging 環境に自動デプロイ
  main push     → production 環境に自動デプロイ（承認ゲート付き）
```

## ネットワーク設計

```
VPC (10.x.0.0/16)     ※ x = 0(dev), 1(staging), 2(prod)
│
├── Public Subnet x2 (10.x.1.0/24, 10.x.2.0/24) - 2AZ
│   ├── ALB
│   └── NAT Gateway
│
├── Private Subnet x2 (10.x.10.0/24, 10.x.11.0/24) - 2AZ
│   └── ECS Fargate (バックエンド)
│
└── Private Subnet x2 (10.x.20.0/24, 10.x.21.0/24) - 2AZ
    └── RDS PostgreSQL
```

## セキュリティグループ

| SG | インバウンド | アウトバウンド |
|---|---|---|
| ALB SG | 443 (0.0.0.0/0) | ECS SG:8000 |
| ECS Backend SG | 8000 (ALB SG) | RDS SG:5432, 443 (外部API) |
| RDS SG | 5432 (ECS Backend SG) | なし |
