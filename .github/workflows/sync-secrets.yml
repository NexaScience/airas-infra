name: Sync Secrets to AWS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - prod
          - both

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  PROJECT: airas

jobs:
  sync-dev:
    name: Sync Secrets (dev)
    if: inputs.environment == 'dev' || inputs.environment == 'both'
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync secrets to AWS Secrets Manager
        env:
          SECRET_PREFIX: ${{ env.PROJECT }}/dev
          GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          ENTERPRISE_ENABLED: ${{ secrets.ENTERPRISE_ENABLED }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
        run: |
          set -euo pipefail

          sync_secret() {
            local secret_name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              echo "Syncing: $secret_name"
              printf '%s' "$value" | aws secretsmanager put-secret-value \
                --secret-id "$secret_name" \
                --secret-string "file:///dev/stdin" \
                --region "$AWS_REGION"
            else
              echo "Skipping (empty): $secret_name"
            fi
          }

          sync_secret "${SECRET_PREFIX}/gh-pat" "$GH_PERSONAL_ACCESS_TOKEN"
          sync_secret "${SECRET_PREFIX}/anthropic-api-key" "$ANTHROPIC_API_KEY"
          sync_secret "${SECRET_PREFIX}/openai-api-key" "$OPENAI_API_KEY"
          sync_secret "${SECRET_PREFIX}/gemini-api-key" "$GEMINI_API_KEY"
          sync_secret "${SECRET_PREFIX}/wandb-api-key" "$WANDB_API_KEY"
          sync_secret "${SECRET_PREFIX}/langfuse-secret-key" "$LANGFUSE_SECRET_KEY"
          sync_secret "${SECRET_PREFIX}/langfuse-public-key" "$LANGFUSE_PUBLIC_KEY"
          sync_secret "${SECRET_PREFIX}/langfuse-base-url" "$LANGFUSE_BASE_URL"
          sync_secret "${SECRET_PREFIX}/qdrant-api-key" "$QDRANT_API_KEY"
          sync_secret "${SECRET_PREFIX}/enterprise-enabled" "$ENTERPRISE_ENABLED"
          sync_secret "${SECRET_PREFIX}/supabase-url" "$SUPABASE_URL"
          sync_secret "${SECRET_PREFIX}/supabase-anon-key" "$SUPABASE_ANON_KEY"
          sync_secret "${SECRET_PREFIX}/supabase-jwt-secret" "$SUPABASE_JWT_SECRET"

          echo "Dev secrets sync complete."

      - name: Sync DATABASE_URL from RDS credentials
        env:
          SECRET_PREFIX: ${{ env.PROJECT }}/dev
        run: |
          set -euo pipefail

          echo "Constructing DATABASE_URL from db-password secret..."
          DB_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id "${SECRET_PREFIX}/db-password" \
            --query 'SecretString' --output text \
            --region "$AWS_REGION")

          DB_USER=$(echo "$DB_SECRET" | jq -r '.username')
          DB_PASS=$(echo "$DB_SECRET" | jq -r '.password')
          DB_HOST=$(echo "$DB_SECRET" | jq -r '.host')
          DB_PORT=$(echo "$DB_SECRET" | jq -r '.port')
          DB_NAME=$(echo "$DB_SECRET" | jq -r '.dbname')

          DB_PASS_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${DB_PASS}', safe=''))" 2>/dev/null || echo "$DB_PASS")

          DATABASE_URL="postgresql+psycopg://${DB_USER}:${DB_PASS_ENCODED}@${DB_HOST}:${DB_PORT}/${DB_NAME}"

          printf '%s' "$DATABASE_URL" | aws secretsmanager put-secret-value \
            --secret-id "${SECRET_PREFIX}/database-url" \
            --secret-string "file:///dev/stdin" \
            --region "$AWS_REGION"

          echo "DATABASE_URL synced successfully."

  sync-prod:
    name: Sync Secrets (prod)
    if: inputs.environment == 'prod' || inputs.environment == 'both'
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync secrets to AWS Secrets Manager
        env:
          SECRET_PREFIX: ${{ env.PROJECT }}/prod
          GH_PERSONAL_ACCESS_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          ENTERPRISE_ENABLED: ${{ secrets.ENTERPRISE_ENABLED }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
        run: |
          set -euo pipefail

          sync_secret() {
            local secret_name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              echo "Syncing: $secret_name"
              printf '%s' "$value" | aws secretsmanager put-secret-value \
                --secret-id "$secret_name" \
                --secret-string "file:///dev/stdin" \
                --region "$AWS_REGION"
            else
              echo "Skipping (empty): $secret_name"
            fi
          }

          sync_secret "${SECRET_PREFIX}/gh-pat" "$GH_PERSONAL_ACCESS_TOKEN"
          sync_secret "${SECRET_PREFIX}/anthropic-api-key" "$ANTHROPIC_API_KEY"
          sync_secret "${SECRET_PREFIX}/openai-api-key" "$OPENAI_API_KEY"
          sync_secret "${SECRET_PREFIX}/gemini-api-key" "$GEMINI_API_KEY"
          sync_secret "${SECRET_PREFIX}/wandb-api-key" "$WANDB_API_KEY"
          sync_secret "${SECRET_PREFIX}/langfuse-secret-key" "$LANGFUSE_SECRET_KEY"
          sync_secret "${SECRET_PREFIX}/langfuse-public-key" "$LANGFUSE_PUBLIC_KEY"
          sync_secret "${SECRET_PREFIX}/langfuse-base-url" "$LANGFUSE_BASE_URL"
          sync_secret "${SECRET_PREFIX}/qdrant-api-key" "$QDRANT_API_KEY"
          sync_secret "${SECRET_PREFIX}/enterprise-enabled" "$ENTERPRISE_ENABLED"
          sync_secret "${SECRET_PREFIX}/supabase-url" "$SUPABASE_URL"
          sync_secret "${SECRET_PREFIX}/supabase-anon-key" "$SUPABASE_ANON_KEY"
          sync_secret "${SECRET_PREFIX}/supabase-jwt-secret" "$SUPABASE_JWT_SECRET"

          echo "Prod secrets sync complete."

      - name: Sync DATABASE_URL from RDS credentials
        env:
          SECRET_PREFIX: ${{ env.PROJECT }}/prod
        run: |
          set -euo pipefail

          echo "Constructing DATABASE_URL from db-password secret..."
          DB_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id "${SECRET_PREFIX}/db-password" \
            --query 'SecretString' --output text \
            --region "$AWS_REGION")

          DB_USER=$(echo "$DB_SECRET" | jq -r '.username')
          DB_PASS=$(echo "$DB_SECRET" | jq -r '.password')
          DB_HOST=$(echo "$DB_SECRET" | jq -r '.host')
          DB_PORT=$(echo "$DB_SECRET" | jq -r '.port')
          DB_NAME=$(echo "$DB_SECRET" | jq -r '.dbname')

          DB_PASS_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${DB_PASS}', safe=''))" 2>/dev/null || echo "$DB_PASS")

          DATABASE_URL="postgresql+psycopg://${DB_USER}:${DB_PASS_ENCODED}@${DB_HOST}:${DB_PORT}/${DB_NAME}"

          printf '%s' "$DATABASE_URL" | aws secretsmanager put-secret-value \
            --secret-id "${SECRET_PREFIX}/database-url" \
            --secret-string "file:///dev/stdin" \
            --region "$AWS_REGION"

          echo "DATABASE_URL synced successfully."
